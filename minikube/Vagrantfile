Vagrant.configure("2") do |config|
  config.vm.box = "centos/7"
  config.vm.network "public_network"

  config.vm.provider :virtualbox do |vbox|
    vbox.name = "minikube"
    vbox.cpus = 2
    vbox.memory = "4096"
    vbox.gui = false
  end

  # Generated by issuing "ssh-keygen -t rsa -C -m PEM"
  config.vm.provision "file", source: "./id_rsa",                  destination: "/home/vagrant/.ssh/id_rsa"
  config.vm.provision "file", source: "./id_rsa.pub",              destination: "/home/vagrant/.ssh/id_rsa.pub"
  config.vm.provision "file", source: "./ssh_config",              destination: "/home/vagrant/.ssh/config"
  config.vm.provision "file", source: "./set_secure_context.sh",   destination: "/home/vagrant/set_secure_context.sh"
  config.vm.provision "file", source: "./set_insecure_context.sh", destination: "/home/vagrant/set_insecure_context.sh"
  
  config.vm.provision "shell", inline: <<-SHELL
    echo "1/7: Setup"
    yum update -y
    yum install -y zip unzip

    echo "2/7: Set SSH Key" 
    cat /home/vagrant/.ssh/id_rsa.pub >> /home/vagrant/.ssh/authorized_keys
    chown -R vagrant /home/vagrant/.ssh
    cp -r /home/vagrant/.ssh /root/.ssh

    echo "3/7: Install docker" 
    curl https://get.docker.com | sh
    systemctl enable docker
    systemctl start docker
    docker --version

    echo "4/7: Install minikube" 
    curl -LO https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64
    install minikube-linux-amd64 /usr/local/bin/minikube
    echo '1' > /proc/sys/net/bridge/bridge-nf-call-iptables
    /usr/local/bin/minikube --vm-driver=none start
    curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.16.0/bin/linux/amd64/kubectl
    install kubectl /usr/local/bin/kubectl

    echo "5/7: Zip minikube config"
    /usr/local/bin/kubectl config view --raw > /root/config
    cp /root/.minikube/ca.* /root/
    cp /root/.minikube/client.* /root/
    mv /home/vagrant/set_* /root/
    zip -rj /root/kube-config.zip /root/config \
      /root/set_secure_context.sh /root/set_insecure_context.sh \
      /root/ca.key /root/ca.crt /root/client.key /root/client.crt

    echo "6/7: Disable firewalld"
    systemctl stop firewalld
    systemctl disable firewalld

    echo "7/7: Enable ssh password login and change passwords"
    sed -i -e 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
    systemctl restart sshd
    echo docker/4u | passwd --stdin root
    echo vagrant/4u | passwd --stdin vagrant

    echo "Completed!!"
    ip a | grep "inet "
  SHELL
  
end
