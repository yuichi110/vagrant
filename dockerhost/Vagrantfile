Vagrant.configure("2") do |config|
  config.vm.box = "centos/7"
  config.vm.network "public_network"

  config.vm.provider :virtualbox do |vbox|
    vbox.name = "docker-host"
    vbox.memory = "2048"
    vbox.gui = false
  end

  # Generated by issuing "ssh-keygen -t rsa -C -m PEM"
  config.vm.provision "file", source: "./id_rsa", destination: "/home/vagrant/.ssh/id_rsa"
  config.vm.provision "file", source: "./id_rsa.pub", destination: "/home/vagrant/.ssh/id_rsa.pub"

  config.vm.provision "shell", inline: <<-SHELL
    #sudo yum update -y
    cat /home/vagrant/.ssh/id_rsa.pub >> /home/vagrant/.ssh/authorized_keys
    sudo useradd docker
    echo docker/4u | sudo passwd --stdin docker
    sudo mkdir /home/docker/.ssh
    sudo chown docker /home/docker/.ssh
    sudo cp /home/vagrant/.ssh/id_rsa /home/docker/.ssh/id_rsa
    sudo cp /home/vagrant/.ssh/id_rsa.pub /home/docker/.ssh/id_rsa.pub
    sudo cp /home/vagrant/.ssh/authorized_keys /home/docker/.ssh/authorized_keys
    sudo chown -R docker /home/docker/.ssh

    curl https://get.docker.com | sh
    sudo usermod -aG docker vagrant
    sudo usermod -aG docker docker
    sudo systemctl enable docker
    sudo systemctl start docker
    docker --version

    sudo curl -L "https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
    /usr/local/bin/docker-compose --version

    sudo sed -i -e 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
    sudo systemctl restart sshd
    echo vagrant/4u | sudo passwd --stdin vagrant
  SHELL
  
end
