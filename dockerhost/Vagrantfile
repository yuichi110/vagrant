Vagrant.configure("2") do |config|
  config.vm.box = "centos/7"
  config.vm.network "public_network"

  config.vm.provider :virtualbox do |vbox|
    vbox.name = "docker-host"
    vbox.cpus = 1
    vbox.memory = "2048"
    vbox.gui = false
  end

  # Generated by issuing "ssh-keygen -t rsa -C -m PEM"
  config.vm.provision "file", source: "./id_rsa",     destination: "/home/vagrant/.ssh/id_rsa"
  config.vm.provision "file", source: "./id_rsa.pub", destination: "/home/vagrant/.ssh/id_rsa.pub"
  config.vm.provision "file", source: "./ssh_config", destination: "/home/vagrant/.ssh/config"

  config.vm.provision "shell", inline: <<-SHELL
    echo "1/6: Update"
    yum update -y

    echo "2/6: Set SSH Key" 
    cat /home/vagrant/.ssh/id_rsa.pub >> /home/vagrant/.ssh/authorized_keys
    chown -R vagrant /home/vagrant/.ssh
    cp -r /home/vagrant/.ssh /root/.ssh

    echo "3/6: Install docker" 
    curl https://get.docker.com | sh
    systemctl enable docker
    systemctl start docker
    docker --version

    echo "4/6: Install docker-compose" 
    curl -L "https://github.com/docker/compose/releases/download/1.24.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    chmod +x /usr/local/bin/docker-compose
    /usr/local/bin/docker-compose --version

    echo "5/6: Disable firewalld"
    systemctl stop firewalld
    systemctl disable firewalld

    echo "6/6: Enable ssh password login and change passwords"
    sed -i -e 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
    systemctl restart sshd
    echo docker/4u | passwd --stdin root
    echo vagrant/4u | passwd --stdin vagrant

    echo "Completed!!"
    ip a | grep "inet "
  SHELL
  
end
